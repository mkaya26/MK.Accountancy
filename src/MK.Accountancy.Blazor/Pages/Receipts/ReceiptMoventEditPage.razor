@inherits BaseEditPage

@inject ReceiptMoventService Service
@inject ReceiptService ReceiptService
@inject BankService BankService
@inject BankDepartmentService BankDepartmentService
@inject BankAccountService BankAccountService
@inject SafeService SafeService

<DevPopupMoventEditPageLayout CancelButtonText="@L["Cancel"]"
                              Caption="@L["ReceiptRow"]"
                              Closed="Service.HideEditPage"
                              MaxHeight="600px"
                              OnSubmit="Service.OnSubmit"
                              Service="Service"
                              SubmitButtonText="@L["Save"]"
                              Width="585px">
    <EditPageContent>
        <DevGridLayout ColumnCount="11"
                       RowCount="2"
                       RowHeights="@RowHeights("28","*")">
            <GridLayoutItems>
                <DxGridLayoutItem Column="0"
                                  Row="0">
                    <Template>
                        <DevGridLayout ColumnCount="3"
                                       ColumnWidths="@ColumnWidths("90","3","120")">
                            <GridLayoutItems>
                                <DevComboboxEnumEdit Caption="@L["PaymentType"]"
                                                     ColumnIndex="2"
                                                     DataSource="@(FillEnumToCombobox<PaymentType>(L))"
                                                     SelectedItemChanged="(e)=>Service.ReceiptMoventTypeSelectedItemChanged(e,StateHasChanged)"
                                                     RowIndex="0"
                                                     TextFieldName="@nameof(ComboboxEnumItem<PaymentType>.DisplayName)"
                                                     TItem="PaymentType"
                                                     @bind-Value="@Service.TempDataSource.PaymentType"
                                                     ValueFieldName="@nameof(ComboboxEnumItem<PaymentType>.Value)">
                                </DevComboboxEnumEdit>
                            </GridLayoutItems>
                        </DevGridLayout>
                    </Template>
                </DxGridLayoutItem>
                <DxGridLayoutItem Column="0"
                                  Row="1"
                                  Visible="Service.TempDataSource.PaymentType == PaymentType.Cheque">
                    <Template>
                        <DevGridLayout ColumnCount="7"
                                       ColumnWidths="@ColumnWidths("90","3","120","25","90","3","120")"
                                       RowCount="11">
                            <GridLayoutItems>
                                <DevTextEdit Caption="@L["TrackingNumber"]"
                                             ColumnIndex="2"
                                             ColumnSpan="3"
                                             Enabled="false"
                                             RowIndex="0"
                                             @bind-Value="@Service.TempDataSource.TrackingNumber">
                                </DevTextEdit>
                                <DevButonEdit ButtonClickInvokeFunction="() => {
                                BankService.BeforeShowPopupListPage(Service.TempDataSource.ChequeBankId);}"
                                              Caption="@L["Bank"]"
                                              ColumnIndex="2"
                                              ColumnSpan="3"
                                              IsFocus="true"
                                              NullText="@L["SelectCard"]"
                                              RowIndex="1"
                                              Service="BankService"
                                              Value="@Service.TempDataSource.ChequeBankName"
                                              ValueChanged="@(()=>{Service.TempDataSource.ChequeBankDepartmentId=null; Service.TempDataSource.ChequeBankDepartmentName=null;})">
                                </DevButonEdit>
                                <DevButonEdit ButtonClickInvokeFunction="() => {
                                BankDepartmentService.BeforeShowPopupListPage(Service.TempDataSource.ChequeBankId,Service.TempDataSource.ChequeBankDepartmentId);}"
                                              Caption="@L["BankBranch"]"
                                              ColumnIndex="2"
                                              ColumnSpan="3"
                                              Enabled="Service.TempDataSource.ChequeBankId != null"
                                              NullText="@L["SelectCard"]"
                                              RowIndex="2"
                                              Service="BankDepartmentService"
                                              @bind-Value="@Service.TempDataSource.ChequeBankDepartmentName">
                                </DevButonEdit>
                                <DevTextEdit Caption="@L["AccountNumber"]"
                                             ColumnIndex="2"
                                             NullText="@L["EnterAccountNumber"]"
                                             RowIndex="3"
                                             @bind-Value="@Service.TempDataSource.ChequeAccountNumber">
                                </DevTextEdit>
                                <DevTextEdit Caption="@L["DocumentNumber"]"
                                             ColumnIndex="2"
                                             NullText="@L["EnterDocumentNumber"]"
                                             RowIndex="4"
                                             @bind-Value="@Service.TempDataSource.DocumentNo">
                                </DevTextEdit>
                                <DevDateEdit Caption="@L["ExpiryDate"]"
                                             ColumnIndex="2"
                                             NullText="@L["EnterDate"]"
                                             RowIndex="5"
                                             @bind-Value="@Service.TempDataSource.ExpiryDate">
                                </DevDateEdit>
                                <DevTextEdit Caption="@L["PrincipalDebtor"]"
                                             ColumnIndex="2"
                                             ColumnSpan="3"
                                             NullText="@L["EnterPrincipalDebtor"]"
                                             RowIndex="6"
                                             @bind-Value="@Service.TempDataSource.PrincipalDebtor">
                                </DevTextEdit>
                                <DevTextEdit Caption="@L["Endorser"]"
                                             ColumnIndex="2"
                                             ColumnSpan="3"
                                             NullText="@L["EnterEndorser"]"
                                             RowIndex="7"
                                             @bind-Value="@Service.TempDataSource.Endorser">
                                </DevTextEdit>
                                <DevCurrencyEdit Caption="@L["Amount"]"
                                                 ColumnIndex="2"
                                                 RowIndex="8"
                                                 @bind-Value="@Service.TempDataSource.Price">
                                </DevCurrencyEdit>
                                <DevMemoEdit Caption="@L["Description"]"
                                             ColumnIndex="2"
                                             ColumnSpan="5"
                                             NullText="@L["EnterDescription"]"
                                             RowIndex="9"
                                             RowSpan="2"
                                             @bind-Value="@Service.TempDataSource.Description">
                                </DevMemoEdit>
                            </GridLayoutItems>
                        </DevGridLayout>
                    </Template>
                </DxGridLayoutItem>

                <DevButonEdit ButtonClickInvokeFunction="() => {
                                StockService.BeforeShowPopupListPage(Service.TempDataSource.StockId);}"
                              Caption="@L["StockCode"]"
                              ColumnIndex="2"
                              ColumnSpan="4"
                              IsFocus="Service.TempDataSource.InvoiceDetailType == InvoiceDetailType.Stock"
                              NullText="@L["SelectCard"]"
                              RowIndex="1"
                              Service="StockService"
                              Value="@Service.TempDataSource.StockCode"
                              ValueChanged="()=>Service.TempDataSource.ItemCode = Service.TempDataSource.StockCode"
                              Visible="Service.TempDataSource.InvoiceDetailType == InvoiceDetailType.Stock">
                </DevButonEdit>
                <DevButonEdit ButtonClickInvokeFunction="() => {
                                ServiceService.BeforeShowPopupListPage(Service.TempDataSource.ServiceId);}"
                              Caption="@L["ServiceCode"]"
                              ColumnIndex="2"
                              ColumnSpan="4"
                              IsFocus="Service.TempDataSource.InvoiceDetailType == InvoiceDetailType.Service"
                              NullText="@L["SelectCard"]"
                              RowIndex="1"
                              Service="ServiceService"
                              Value="@Service.TempDataSource.ServiceCode"
                              ValueChanged="()=>Service.TempDataSource.ItemCode = Service.TempDataSource.ServiceCode"
                              Visible="Service.TempDataSource.InvoiceDetailType == InvoiceDetailType.Service">
                </DevButonEdit>
                <DevButonEdit ButtonClickInvokeFunction="() => {
                                ExpenseService.BeforeShowPopupListPage(Service.TempDataSource.ExpenseId);}"
                              Caption="@L["ExpenseCode"]"
                              ColumnIndex="2"
                              ColumnSpan="4"
                              IsFocus="Service.TempDataSource.InvoiceDetailType == InvoiceDetailType.Expense"
                              NullText="@L["SelectCard"]"
                              RowIndex="1"
                              Service="ExpenseService"
                              Value="@Service.TempDataSource.ExpenceCode"
                              ValueChanged="()=>Service.TempDataSource.ItemCode = Service.TempDataSource.ExpenceCode"
                              Visible="Service.TempDataSource.InvoiceDetailType == InvoiceDetailType.Expense">
                </DevButonEdit>
                <DevTextEdit Caption="@L["StockName"]"
                             ColumnIndex="2"
                             ColumnSpan="5"
                             Enabled="false"
                             RowIndex="2"
                             Value="@Service.TempDataSource.StockName"
                             ValueChanged="()=>Service.TempDataSource.ItemName = Service.TempDataSource.StockName"
                             Visible="Service.TempDataSource.InvoiceDetailType == InvoiceDetailType.Stock">
                </DevTextEdit>
                <DevTextEdit Caption="@L["ServiceName"]"
                             ColumnIndex="2"
                             ColumnSpan="5"
                             Enabled="false"
                             RowIndex="2"
                             Value="@Service.TempDataSource.ServiceName"
                             ValueChanged="()=>Service.TempDataSource.ItemName = Service.TempDataSource.ServiceName"
                             Visible="Service.TempDataSource.InvoiceDetailType == InvoiceDetailType.Service">
                </DevTextEdit>
                <DevTextEdit Caption="@L["ExpenseName"]"
                             ColumnIndex="2"
                             ColumnSpan="5"
                             Enabled="false"
                             RowIndex="2"
                             Value="@Service.TempDataSource.ExpenceName"
                             ValueChanged="()=>Service.TempDataSource.ItemName = Service.TempDataSource.ExpenceName"
                             Visible="Service.TempDataSource.InvoiceDetailType == InvoiceDetailType.Expense">
                </DevTextEdit>


                <DevCurrencyEdit Caption="@L["UnitPrice"]"
                                 ColumnIndex="6"
                                 RowIndex="3"
                                 Value="@Service.TempDataSource.UnitPrice"
                                 ValueChanged="(e)=>Service.Calc(e,nameof(Service.TempDataSource.UnitPrice))">
                </DevCurrencyEdit>
                <DevSpinEdit Caption="@L["ValueAddedTaxRate"]"
                             ColumnIndex="2"
                             RowIndex="4"
                             Value="@Service.TempDataSource.TaxRate"
                             ValueChanged="(e)=>Service.Calc(e,nameof(Service.TempDataSource.TaxRate))">
                </DevSpinEdit>
                <DevCurrencyEdit Caption="@L["GrossAmount"]"
                                 ColumnIndex="10"
                                 Enabled="false"
                                 RowIndex="3"
                                 @bind-Value="@Service.TempDataSource.GrossAmount">
                </DevCurrencyEdit>
                <DevCurrencyEdit Caption="@L["DiscountAmount"]"
                                 ColumnIndex="6"
                                 RowIndex="4"
                                 Value="@Service.TempDataSource.DiscountAmount"
                                 ValueChanged="(e)=>Service.Calc(e,nameof(Service.TempDataSource.DiscountAmount))">
                </DevCurrencyEdit>
                <DevCurrencyEdit Caption="@L["ExcludesValueAddedTaxAmount"]"
                                 ColumnIndex="10"
                                 Enabled="false"
                                 RowIndex="4"
                                 @bind-Value="@Service.TempDataSource.SubTotal">
                </DevCurrencyEdit>
                <DevCurrencyEdit Caption="@L["ValueAddedTaxAmount"]"
                                 ColumnIndex="10"
                                 Enabled="false"
                                 RowIndex="5"
                                 @bind-Value="@Service.TempDataSource.TaxTotal">
                </DevCurrencyEdit>
                <DevCurrencyEdit Caption="@L["TotalAmount"]"
                                 ColumnIndex="10"
                                 Enabled="false"
                                 RowIndex="6"
                                 @bind-Value="@Service.TempDataSource.NetTotal">
                </DevCurrencyEdit>

            </GridLayoutItems>
        </DevGridLayout>
    </EditPageContent>
</DevPopupMoventEditPageLayout>

@if (StockService.IsPopupListPage)
{
    <DevPopupListPageLayout DataGridService="StockService"
                        CancelButtonText="@L["Cancel"]"
                        Caption="@L["StockCards"]"
                        Closed="StockService.HideListPage"
                        SelectButtonInvokeFunction="(() => {StockService.SelectEntity(Service.TempDataSource);})"
                        SelectButtonText="@L["Select"]"
                        Visible="true"
                        Width="1000px">
        <ListPageContent>
            <StockListPage />
        </ListPageContent>
    </DevPopupListPageLayout>
}
@if (ServiceService.IsPopupListPage)
{
    <DevPopupListPageLayout DataGridService="ServiceService"
                        CancelButtonText="@L["Cancel"]"
                        Caption="@L["ServiceCards"]"
                        Closed="ServiceService.HideListPage"
                        SelectButtonInvokeFunction="(() => {ServiceService.SelectEntity(Service.TempDataSource);})"
                        SelectButtonText="@L["Select"]"
                        Visible="true"
                        Width="1000px">
        <ListPageContent>
            <ServiceListPage />
        </ListPageContent>
    </DevPopupListPageLayout>
}
@if (ExpenseService.IsPopupListPage)
{
    <DevPopupListPageLayout DataGridService="ExpenseService"
                        CancelButtonText="@L["Cancel"]"
                        Caption="@L["ExpenceCards"]"
                        Closed="ExpenseService.HideListPage"
                        SelectButtonInvokeFunction="(() => {ExpenseService.SelectEntity(Service.TempDataSource);})"
                        SelectButtonText="@L["Select"]"
                        Visible="true"
                        Width="1000px">
        <ListPageContent>
            <ExpenseListPage />
        </ListPageContent>
    </DevPopupListPageLayout>
}
@if (StoreService.IsPopupListPage)
{
    <DevPopupListPageLayout DataGridService="StoreService"
                        CancelButtonText="@L["Cancel"]"
                        Caption="@L["WarehouseCards"]"
                        Closed="StoreService.HideListPage"
                        SelectButtonInvokeFunction="(() => {StoreService.SelectEntity(Service.TempDataSource);})"
                        SelectButtonText="@L["Select"]"
                        Visible="true"
                        Width="1000px">
        <ListPageContent>
            <StoreListPage />
        </ListPageContent>
    </DevPopupListPageLayout>
}

@code {
    protected override void OnInitialized()
    {
        Service.TempDataSource = ObjectMapper.Map<SelectInvoiceDetailDto, SelectInvoiceDetailDto>(Service.DataSource);
    }
}